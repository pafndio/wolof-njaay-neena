{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Statistiques -->
    <div class="stats-bar">
        <div class="stat-item">
            <i class="fas fa-eye"></i>
            <span id="stats-vues">{{ stats.vues }}</span> / {{ stats.total }} citations vues
        </div>
        <div class="stat-item">
            <i class="fas fa-hourglass-half"></i>
            <span id="stats-restantes">{{ stats.restantes }}</span> restantes
        </div>
    </div>

    <!-- Carte de citation -->
    <div class="quote-card" id="quote-card">
        <!-- Bordure supérieure avec motif Kente -->
        <div class="border-top"></div>
        
        <!-- Bordure inférieure avec motif Kente -->
        <div class="border-bottom"></div>
        
        <!-- Bordure gauche avec dégradé -->
        <div class="border-left"></div>
        
        <!-- Bordure droite avec dégradé -->
        <div class="border-right"></div>
        
        <!-- Coins décoratifs -->
        <div class="corner corner-tl"></div>
        <div class="corner corner-tr"></div>
        <div class="corner corner-bl"></div>
        <div class="corner corner-br"></div>
        
        <!-- Contenu -->
        <div class="quote-content">
            <!-- Texte d'introduction -->
            <div class="quote-intro">
                <h2 class="intro-text" id="intro-text">
                    Wolof njaay neena tay <span id="date-text">{{ date_fr }}</span>
                </h2>
                <div class="intro-line"></div>
            </div>
            
            <!-- Citation -->
            <div class="quote-text-container">
                <p class="quote-text" id="quote-text">{{ citation.leebu }}</p>
            </div>
            
            <!-- Numéro -->
            <div class="quote-numero">
                <p>Citation #<span id="quote-numero">{{ citation.numero }}</span></p>
            </div>
        </div>
    </div>

    <!-- Boutons d'action -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="nouvelleCitation()">
            <i class="fas fa-sync-alt"></i> Nouvelle citation
        </button>
        
        <button class="btn btn-outline" onclick="telechargerImage()">
            <i class="fas fa-download"></i> Télécharger
        </button>
        
        <button class="btn btn-outline" onclick="copierTexte()">
            <i class="fas fa-copy"></i> Copier
        </button>
        
        <button class="btn btn-outline" onclick="partager()">
            <i class="fas fa-share-alt"></i> Partager
        </button>
    </div>

    <!-- Information -->
    <div class="info-box">
        <p>
            <i class="fas fa-info-circle"></i>
            Chaque citation est unique et ne se répète pas jusqu'à ce que toutes aient été vues.
            La boucle recommence automatiquement après.
        </p>
    </div>

    <!-- Bouton de réinitialisation (admin) -->
    <div class="admin-section">
        <button class="btn btn-secondary" onclick="resetCitations()">
            <i class="fas fa-redo"></i> Réinitialiser toutes les citations
        </button>
    </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Fonction pour afficher une notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast-${type} show`;
    
    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}

// Fonction pour obtenir une nouvelle citation
async function nouvelleCitation() {
    try {
        const response = await fetch('/api/nouvelle-citation');
        const data = await response.json();
        
        // Mettre à jour l'affichage
        document.getElementById('quote-text').textContent = data.citation.leebu;
        document.getElementById('quote-numero').textContent = data.citation.numero;
        document.getElementById('date-text').textContent = data.date_fr;
        document.getElementById('stats-vues').textContent = data.stats.vues;
        document.getElementById('stats-restantes').textContent = data.stats.restantes;
        
        showToast('Nouvelle citation chargée !', 'success');
    } catch (error) {
        showToast('Erreur lors du chargement', 'error');
    }
}

// Fonction pour télécharger l'image
async function telechargerImage() {
    try {
        const card = document.getElementById('quote-card');
        const canvas = await html2canvas(card, {
            backgroundColor: '#ffffff',
            scale: 2,
            logging: false,
            useCORS: true
        });
        
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'leebu-wolof-citation.png';
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('Image téléchargée !', 'success');
        });
    } catch (error) {
        showToast('Erreur lors du téléchargement', 'error');
    }
}

// Fonction pour copier le texte
function copierTexte() {
    const texte = document.getElementById('quote-text').textContent;
    navigator.clipboard.writeText(texte).then(() => {
        showToast('Texte copié !', 'success');
    }).catch(() => {
        showToast('Erreur lors de la copie', 'error');
    });
}

// Fonction pour partager
async function partager() {
    const texte = document.getElementById('quote-text').textContent;
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: 'Leebu Wolof - Citation du Jour',
                text: texte,
                url: window.location.href
            });
            showToast('Partagé avec succès !', 'success');
        } catch (error) {
            if (error.name !== 'AbortError') {
                showToast('Erreur lors du partage', 'error');
            }
        }
    } else {
        // Fallback: copier le texte
        copierTexte();
    }
}

// Fonction pour réinitialiser les citations
async function resetCitations() {
    if (confirm('Voulez-vous vraiment réinitialiser toutes les citations vues ?')) {
        try {
            const response = await fetch('/api/reset');
            const data = await response.json();
            
            if (data.success) {
                showToast('Citations réinitialisées !', 'success');
                nouvelleCitation();
            }
        } catch (error) {
            showToast('Erreur lors de la réinitialisation', 'error');
        }
    }
}
</script>
{% endblock %}
